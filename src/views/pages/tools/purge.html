<link rel="ractive" href="../../r-page.html">
<link rel="ractive" href="../../components/header.html" name="c-header">
<link rel="ractive" href="../../components/notification.html" name="c-notification">
<link rel="ractive" href="../../components/header-gradient.html" name="c-header-gradient">

<r-page noYield="{{noYield}}" title="{{title}}" description="{{description}}">
	<c-notification></c-notification>
	<c-header></c-header>

	<div class="p-purge">
		<c-header-gradient></c-header-gradient>

		<div class="container">
			<section class="heading">
				<h1 class="page-title">Purge jsDelivr CDN cache</h1>
				<div class="subtitle">
					<span>Purge the cache of a @latest or version aliased URL to force your users to get the new</span>
					<span>updated version. Otherwise they might wait up to 7 days.</span>
				</div>

				<div class="purge-form">
					<textarea
						class-loading="purging"
						class="input"
						rows="2"
						placeholder="You can cache up to 10 URLs, separated by a comma &quot;,&quot;"
						value="{{urls}}">
					</textarea>

					{{#if purging}}
						<a class="animated" class-loading="purging">
							<div class="animation"></div>
						</a>
					{{else}}
						<a class="btn-primary">
							<span on-click="@this.set('proceedToCaptcha', true)">Purge now</span>
						</a>
					{{/if}}

					{{#if requestFailed}}
						<label class="error">An error occurred while purging!</label>
					{{/if}}

					<div class="recaptcha-wrapper{{#if proceedToCaptcha}} visible{{/if}}">
						<div id="recaptcha-service" class="g-recaptcha" data-callback="recaptchaCallback" data-sitekey="6LdXrfkUAAAAAFkzRiSAV4MBvUfNR1aynq1ggATK"></div>
					</div>
					<script type="text/javascript" src="https://www.google.com/recaptcha/api.js?hl=en"></script>
				</div>
			</section>

			<!-- {{#if results.length}} -->
			{{#if true}}
				<section class="results">
					<h2>
						<span>Results</span>
						<span>Hide details</span>
						<!-- <span>Show details</span> -->
					</h2>

					<div class="results-table">
						{{#each results}}
							<div class="results-item">
								<div class="item-descr">
									<span>{{this.fileName}}</span>
									<span class="item-status success">
										{{this.message}}
										<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/chevron-down.svg" />
									</span>
								</div>

								<div class="divider"></div>

								<div class="item-cdns">
									{{#each this.status}}
										<span>
											{{#if this.success === true}}
												<img width="24" height="24" src="{{@shared.assetsHost}}/img/icons/check-circle.full.svg">
											{{else}}
												<img width="24" height="24" src="{{@shared.assetsHost}}/img/icons/close.svg">
											{{/if}}
											{{this.name}}
										</span>
									{{/each}}
								</div>
							</div>
						{{/each}}
					</div>
				</section>
			{{/if}}
		</div>
	</div>

</r-page>

<script>
	const mockResults = [
		{
			fileName: 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/AUTHORS.txt',
			message: 'Success',
			status: [
				{
					name: 'Bunny.net',
					success: true,
				},
				{
					name: 'Cloudflare',
					success: true,
				},
				{
					name: 'Fastly',
					success: true,
				},
				{
					name: 'Quantil',
					success: true,
				},
			],
		},
		{
			fileName: 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/Example.txt',
			message: 'One provider failed',
			status: [
				{
					name: 'Bunny.net',
					success: true,
				},
				{
					name: 'Cloudflare',
					success: true,
				},
				{
					name: 'Fastly',
					success: true,
				},
				{
					name: 'Quantil',
					success: false,
				},
			],
		},
		{
			fileName: 'https://cdn.jsdelivr.net/npm/jquery@3.2.1/Default.txt',
			message: 'Success',
			status: [
				{
					name: 'Bunny.net',
					success: true,
				},
				{
					name: 'Cloudflare',
					success: true,
				},
				{
					name: 'Fastly',
					success: true,
				},
				{
					name: 'Quantil',
					success: true,
				},
			],
		},
	];
	component.exports = {
		data () {
			return {
				title: 'Purge CDN cache - jsDelivr',
				purging: false,
				requestFailed: false,
				results: mockResults,
				captchaToken: '',
				proceedToCaptcha: false,
			};
		},
		oninit () {
			if (!Ractive.isServer) {
				let recaptchaCallback = (token) => {
					this.set('captchaToken', token);
				};

				window.recaptchaCallback = undefined;

				$(document).ready(() => {
					window.recaptchaCallback = recaptchaCallback;
				});


				this.observe('captchaToken', (token) => {
					if (token) {
						this.purge();
					}
				});
			}
		},
		purge () {
			this.set('purging', true);
			this.set('requestFailed', false);

			let paths = this.get('urls').replace(/\s+/g, '');

			if (paths === '') {
				this.set('purging', false);
				return;
			}

			paths = paths.split(',');

			if (paths.length > 10) {
				this.set('purging', false);
				return;
			}

			$.ajax({
				type: 'POST',
				crossOrigin: true,
				headers: {
					'content-type': 'application/json',
				},
				url: 'https://purge.jsdelivr.net/captcha',
				data: JSON.stringify({ 'g-recaptcha-response': this.get('captchaToken'), 'path': paths }),
			}).done(() => {
				// let results = [];
				// let providers = Object.keys(response.cdn);

				// for (let provider of providers) {
				// 	results.push({
				// 		name: provider,
				// 		result: response.cdn[provider],
				// 	});
				// }

				// this.set('results', mockResults);

				this.set('purging', false);
				this.set('proceedToCaptcha', false);
			}).fail(() => {
				this.set('purging', false);
				this.set('requestFailed', true);
				this.set('proceedToCaptcha', false);
			});
		},
	};
</script>
