<link rel="ractive" href="./collection-box.html" name="c-collection-box">
<link rel="ractive" href="./package-file-browser.html" name="c-package-file-browser">
<link rel="ractive" href="./package-header.html" name="c-package-header">
<link rel="ractive" href="./top-stats-table.html" name="c-top-stats-table">
<link rel="ractive" href="./version-dropdown.html" name="c-version-dropdown">
<link rel="ractive" href="./package-sidemenu.html" name="c-package-sidemenu">

<div class="c-package">
	<div class="container">
		{{#if versions}}
			<div class="row">
				<div class="main-content">
					<c-package-header
						package="{{package}}"
						type="{{type}}"
						name="{{name}}"
						version="{{version}}"
						packageVersionsNotFound="{{packageVersionsNotFound}}"
						navRoute="{{navRoute}}">
					</c-package-header>

					<div class="package-nav">
						<a on-click="@this.set('navRoute', 'readme')" class="package-nav-route {{navRoute === 'readme' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/book.svg"><span>Readme</span>
						</a>
						<a on-click="@this.set('navRoute', 'config')" class="package-nav-route {{navRoute === 'config' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/settings.svg"><span>Show/Configure Files</span>
						</a>
						<a on-click="@this.set('navRoute', 'stats')" class="package-nav-route {{navRoute === 'stats' ? 'package-nav-route-active' : ''}}">
							<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/statistics.svg"><span>Statistics</span>
						</a>
						<a target="_blank" rel="nofollow noopener" href="https://cdn.jsdelivr.net/npm/{{name}}/" class="package-nav-route">
							<span>Browse CDN Files</span><img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/external-link.svg">
						</a>
					</div>

					{{#if navRoute === 'readme'}}
						<div class="package-readme">
							<div class="header-primary mb-8">{{name}}</div>
							<div class="description mb-32">
								jQuery is a fast, small, and feature-rich JavaScript library.
								<br />
								<br />
								For information on how to get started and how to use {{name}}, please see <a href="/" class="package-link">{{name}}'s documentation</a>.
								For source files and issues, please visit the <a href="/" class="package-link">{{name}} repo</a>.
								<br />
								<br />
								If upgrading, please see the <a href="/" class="package-link">blog post for {{version}}</a>. This includes notable differences from the previous version and a more readable changelog.
							</div>

							<div class="header-secondary mb-8">Including {{name}}</div>
							<div class="text-primary mb-32">Below are some of the most common ways to include {{name}}.</div>

							<div class="header-tertiary mb-32">Keywords</div>

							<div class="script-card mb-32">
								<div class="text-secondary">Script tag</div>
								<div class="script-block mt-16">
									&#60;script src="https://code.jquery.com/jquery-3.6.0.min.js"&#62;&#60;/script&#62;
								</div>
							</div>

							<div class="script-card mb-32">
								<div class="text-secondary mb-8">Babel</div>
								<div class="text-primary">
									<a target="_blank" href="https://babeljs.io/" class="package-link" rel="noopener">Babel</a> is a next generation JavaScript compiler. One of the features is the ability to use ES6/ES2015 modules now,
									even though browsers do not yet support this feature natively.
								</div>
								<div class="script-block mt-16">
									<span class="text-js-keywords">import</span> $ <span class="text-js-keywords">from</span> <span class="text-js-string">"{{name}}"</span>;
								</div>
							</div>

							<div class="script-card">
								<div class="text-secondary mb-8">Browserify/Webpack</div>
								<div class="text-primary">
									There are several ways to use Browserify and Webpack. For more information on using these tools, please refer to
									the corresponding project's documentation. In the script, including jQuery will usually look like this...
								</div>
								<div class="script-block mt-16">
									<span class="text-js-keywords">var</span> $ = <span class="text-js-func">require</span>( <span class="text-js-string">"{{name}}"</span> );
								</div>
							</div>
						</div>
					{{/if}}
				</div>

				<div class="side-content">
					<c-package-sidemenu
						navRoute="{{navRoute}}"
						name="{{name}}"
						type="{{type}}"
						package="{{package}}">
					</c-package-sidemenu>
				</div>

				{{#if navRoute === 'config'}}
					<div class="package-config full-width-content">
						<c-package-file-browser
							type="{{type}}"
							name="{{name}}"
							github="{{package.githubRepo}}"
							version="{{version}}"
							versions="{{versions}}"
							path="{{path}}"
							collection="{{collection}}"
							files="{{~/files}}">
						</c-package-file-browser>

						<c-collection-box collection="{{collection}}"></c-collection-box>
					</div>
				{{elseif navRoute === 'stats'}}
					<div class="package-statistics full-width-content">
						<div class="header">
							<div class="header-title">Statistics</div>
							<div class="header-ctrls">
								<div class="chart-type-ctrl">
									<span>Show numers of</span>

									<input id="chart-switch"
										type="checkbox"
										class="chart-type-switch {{#if showChartBandwidth}}checked{{/if}}"
										twoway="false">

									<label for="chart-switch" on-click="@this.set('showChartBandwidth', !showChartBandwidth)">
										<span>Request</span>
										<span>GB</span>
									</label>
								</div>

								<div class="data-range-ctrl">
									<span>Data range:</span>

									<div class="btn-group">
										<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
											<span>{{~/statsPeriods[statsPeriod]}}</span>
											<i class="fa fa-angle-down" aria-hidden="true"></i>
										</button>

										<ul class="dropdown-menu">
											{{#each ~/statsPeriods}}
												<li><a on-click="@this.set('statsPeriod', @key)">{{this}}</a></li>
											{{/each}}
										</ul>
									</div>
								</div>
							</div>
						</div>
						<div class="stats-cards">
							<div>
								<div class="card-icon">
									<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/request.svg">
								</div>
								<div class="card-main-stat">
									<span>{{_.formatNumber(versionsHitsData.total)}}</span>
									<span>Requests Served</span>
								</div>
								<div class="card-growth">
									<span class="growth-positive">+34%</span>
									<span>monthly growth</span>
								</div>
							</div>

							<div>
								<div class="card-icon">
									<img width="20" height="20" src="{{@shared.assetsHost}}/img/icons/transfer.svg">
								</div>
								<div class="card-main-stat">
									<span>648 414</span>
									<span>Bandwidth</span>
								</div>
								<div class="card-growth">
									<span class="growth-negative">-9%</span>
									<span>monthly growth</span>
								</div>
							</div>
						</div>

						<div class="chart-stats-per-period">
							{{#if totalStats.total}}
								<div class="package-usage">
									<div class="small-headline">Stats for last month</div>

									<div class="group-by-ctrl">
										<span>
											Group by:
										</span>

										<div class="btn-group">
											<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
												<span>{{~/usageChartGroupByValues[usageChartGroupBy]}}</span>
												<i class="fa fa-angle-down" aria-hidden="true"></i>
											</button>

											<ul class="dropdown-menu">
												{{#each ~/usageChartGroupByValues}}
													<li><a on-click="@this.set('usageChartGroupBy', @key)">{{this}}</a></li>
												{{/each}}
											</ul>
										</div>
									</div>
								</div>

								<div class="stats-chart-block">
									<div class="chart-x">
										<div class="x-day-row">
											{{#each ~/statsChartDates.periodDays}}
												<div>{{this}}</div>
											{{/each}}
										</div>

										<div class="x-month-row">
											{{#each ~/statsChartDates.periodMonths}}
												<div>{{this}}</div>
											{{/each}}
										</div>
									</div>
							
									<div class="chart-y">
										{{#with _.linRange(totalStatsMax, 8).reverse() as range}}
											{{#each range}}
												<div>
													{{_.formatNumber(this)}}
												</div>
												
											{{/each}}
										{{/with}}
									</div>

									<div class="stats-chart-wrapper">
										<canvas id="stats-chart" width="1116" height="236"></canvas>
									</div>
								</div>
							{{else}}
								<div class="container">
									<section class="package-usage-empty"></section>
								</div>
							{{/if}}
						</div>

						<div class="horizontal-divider mt-40 mb-40"></div>

						<div class="chart-tops">
							{{#if ~/topFiveVersions}}
								<c-top-stats-table title="Top 5 versions" data="{{~/topFiveVersions}}" type="{{~/type}}" name="{{~/name}}" version="{{~/fileStatsVersion}}">
									{{#partial column1}}
										<a on-click="@this.set('version', version)">{{version}}</a>
									{{/partial}}
								</c-top-stats-table>

								<c-top-stats-table data="{{~/fileStats.slice(0, 5)}}" type="{{~/type}}" name="{{~/name}}" version="{{~/fileStatsVersion}}" versions="{{versions}}">
									{{#partial header}}
										Top 5 files in v{{~/version}}
									{{/partial}}

									{{#partial column1}}
										<a title="{{file}}" target="_blank" href="https://cdn.jsdelivr.net/{{~/type}}/{{~/name}}@{{~/version}}{{file}}">{{file}}</a>
									{{/partial}}
								</c-top-stats-table>
							{{/if}}
						</div>

						<div class="horizontal-divider mt-40 mb-40"></div>

						<div class="chart-hits-per-period">
							{{#if versionsHitsData.total}}
								<div class="package-usage">
									<div class="small-headline">Hits per day per version</div>
								</div>

								<div class="hits-chart-block">
									<div class="chart-x">
										<div class="x-day-row">
											{{#each ~/hitsChartDates.periodDays}}
												<div>{{this}}</div>
											{{/each}}
										</div>

										<div class="x-month-row">
											{{#each ~/hitsChartDates.periodMonths}}
												<div>{{this}}</div>
											{{/each}}
										</div>
									</div>
							
									<div class="chart-y">
										{{#with _.linRange(hitsChartYMax, 8).reverse() as range}}
											{{#each range}}
												<div>
													{{_.formatNumber(this)}}
													<div class="y-line"></div>
												</div>
											{{/each}}
										{{/with}}
									</div>

									<div class="hits-chart-wrapper">
										<canvas id="hits-chart" width="1110" height="245"></canvas>
									</div>
								</div>

								<div class="hits-chart-legend">
									<div class="legend-item">
										<div></div>
										{{topFiveVersions[0].version}}
									</div>
									<div class="legend-item">
										<div></div>
										{{topFiveVersions[1].version}}
									</div>
									<div class="legend-item">
										<div></div>
										{{topFiveVersions[2].version}}
									</div>
									<div class="legend-item">
										<div></div>
										{{topFiveVersions[3].version}}
									</div>
									<div class="legend-item">
										<div></div>
										{{topFiveVersions[4].version}}
									</div>
								</div>
							{{/if}}
						</div>
					</div>
				{{/if}}
			</div>
		{{/if}}
	</div>
</div>

<script>
	const _ = require('../../public/js/_');
	const http = require('../../public/js/utils/http');
	const debounce = require('../../public/js/utils/debounce');
	const clipboard = require('../../public/js/decorators/clipboard');
	const tooltip = require('../../public/js/decorators/tooltip');

	component.exports = {
		computed: {
			// TODO: add resizing to both stats and hits charts
			// chartXInterval () {
			// 	this.get('_resizeId'); // Keep this here so that it updates on resize.
			// 	return this.get('bottomChartLabels') ? Math.ceil(this.get('bottomChartLabels').length / Math.floor(innerWidth / 140)) : 1;
			// },
			hasSourceMaps () {
				let files = this.get('files');
				let hasMin, hasMap;

				if (!files) {
					return true;
				}

				_.flattenFiles(files).forEach((file) => {
					if (/\.min\.(?:js|css)$/.test(file)) {
						hasMin = true;
					} else if (/\.map$/.test(file)) {
						hasMap = true;
					}
				});

				return !hasMin || hasMap;
			},
			issueSourceMaps () {
				return `https://github.com/${this.get('package.githubRepo.user')}/${this.get('package.githubRepo.project')}/issues/new/`
					+ `?title=No source maps for minified files`
					+ `&body=[This package](${this.get('@global.location.href')}) doesn't contain source maps for the minified files. It would be great to add them for easier debugging.`;
			},
		},
		data () {
			return {
				_,
				collection: [],
				statsPeriods: {
					1: 'day',
					7: 'week',
					30: 'month',
					365: 'year',
				},
				statsPeriod: 30,
				versions: [],
				link: location.href,
				_resizeId: 0,
				navRoute: 'readme',
				showChartBandwidth: false,
				usageChartGroupByValues: {
					day: 'day',
					week: 'week',
					month: 'month',
				},
				usageChartGroupBy: 'day',
			};
		},
		decorators: {
			clipboard,
			tooltip,
		},
		oninit () {
			if (!Ractive.isServer) {
				let statsChart;
				let hitsChart;

				// Load package versions.
				http.fetchPackageVersions(this.get('type'), this.get('name')).then((data) => {
					this.set('versions', data.versions);

					// This can only happen for GitHub packages.
					if (data.versions.length === 0) {
						return this.set({ packageVersionsNotFound: true });
					}

					// Set version for GitHub packages.
					if (!this.get('package.version')) {
						this.set('package.version', data.versions[0]);
					}

					// Set version for GitHub packages or when an invalid version is selected.
					if (!this.get('version') || data.versions.indexOf(this.get('version')) === -1) {
						this.set('version', data.versions[0]);
					}
				}).catch((error) => {
					this.set({ packageNotFound: true });
					console.error(`Package versions not found.`, error);
				});

				this.observe('statsPeriod fileStatsVersion', () => {
					if (this.get('statsPeriod') && this.get('fileStatsVersion')) {
						let type = this.get('type');
						let name = this.get('name');
						let version = this.get('fileStatsVersion');
						let period = this.get('statsPeriods')[this.get('statsPeriod')];

						Pace.restart();

						http.fetchPackageFileStats(type, name, version, period).then((data) => {
							let array = [];

							Object.keys(data.files).forEach((key) => {
								array.push({
									file: key,
									hits: data.files[key].total,
								});
							});

							this.animate('fileStats', array.sort((a, b) => b.hits - a.hits));
						});
					}
				});

				this.observe('statsPeriod version navRoute', () => {
					if (this.get('statsPeriod') && this.get('version')) {
						let type = this.get('type');
						let name = this.get('name');
						let period = this.get('statsPeriods')[this.get('statsPeriod')];

						// get package date stats data and create stats chart
						http.fetchPackageDateStats(type, name, period).then((response) => {
							let maxValue = Math.max(...Object.keys(response.dates).map(date => response.dates[date].total));
							let magnitude = Math.floor(Math.log10(maxValue));
							this.set('totalStatsMax', Math.ceil(maxValue / Math.pow(10, magnitude)) * Math.pow(10, magnitude));
							this.set('totalStats', response);

							if (!response.total) {
								return;
							}

							let array = [];

							Object.keys(response.dates).forEach((date) => {
								array.push([ date, response.dates[date] ]);
							});

							array.sort((a, b) => new Date(a[0]) - new Date(b[0]));

							if (statsChart) {
								statsChart.destroy();
								statsChart = null;
							}

							let labels = array.map(value => _.formatDate(new Date(value[0])).toUpperCase());
							let data = array.map(value => value[1].total);

							let chartPeriodDates = array.map(date => date[0]);
							this.set('statsChartDates', _.getPackageTabChartYDates(chartPeriodDates));

							let chartEl = this.find('#stats-chart');
							let chartBarContext = chartEl.getContext('2d');
							let barBackground = chartBarContext.createLinearGradient(0, 0, 0, 300);
							barBackground.addColorStop(0, 'rgb(246, 81, 40)');
							barBackground.addColorStop(1, 'rgba(246, 81, 40, 0.08)');

							statsChart = new Chart(chartEl, {
								type: 'bar',
								data: {
									labels,
									datasets: [{
										data,
										backgroundColor: barBackground,
										borderWidth: 0,
										pointRadius: 0,
										barThickness: 10,
									}],
								},
								options: {
									plugins: {
										legend: {
											display: false,
										},
									},
									scales: {
										x: {
											display: false,
											grid: {
												display: false,
												drawBorder: false,
												borderColor: '#dadde2',
											},
										},
										y: {
											display: false,
											grid: {
												display: false,
												borderColor: '#dadde2',
											},
										},
									},
								},
							});
						});

						// get package versions data and create hits chart
						http.fetchPackageVersionStats(type, name, period).then((data) => {
							let array = [];

							Object.keys(data.versions).forEach((key) => {
								array.push({
									version: key,
									hits: data.versions[key].total,
									dates: data.versions[key].dates,
								});
							});

							let topFiveVersions = array.sort((a, b) => b.hits - a.hits).slice(0, 5);

							let maxValue = Math.max(...topFiveVersions.map(version => Math.max(...Object.values(version.dates))));
							let magnitude = Math.floor(Math.log10(maxValue));
							this.set('hitsChartYMax', Math.ceil(maxValue / Math.pow(10, magnitude)) * Math.pow(10, magnitude));
							this.animate('versionsHitsData', data);
							this.animate('topFiveVersions', topFiveVersions);

							// Maybe we have no stats yet.
							if (array[0]) {
								this.set('fileStatsVersion', array[0].version);
							}

							if (hitsChart) {
								hitsChart.destroy();
								hitsChart = null;
							}

							let chartPeriodDates = Object.keys(topFiveVersions[0].dates);

							this.set('hitsChartDates', _.getPackageTabChartYDates(chartPeriodDates));
							this.set('hitsChartLabels', chartPeriodDates.map(value => _.formatDate(new Date(value)).toUpperCase()));

							let chartEl = this.find('#hits-chart');

							hitsChart = new Chart(chartEl, {
								type: 'line',
								data: {
									labels: [],
									datasets: [
										{
											data: topFiveVersions[0].dates,
											borderColor: '#5C667A',
										},
										{
											data: topFiveVersions[1].dates,
											borderColor: '#BC5090',

										},
										{
											data: topFiveVersions[2].dates,
											borderColor: '#FFA600',
										},
										{
											data: topFiveVersions[3].dates,
											borderColor: '#FF6361',
										},
										{
											data: topFiveVersions[4].dates,
											borderColor: '#69C4F7',
										},
									],
								},
								options: {
									layout: {
										padding: {
											top: 20,
										},
									},
									elements: {
										line: {
											borderWidth: 3,
										},
										point: {
											pointRadius: 0,
										},
									},
									plugins: {
										legend: {
											display: false,
										},
									},
									scales: {
										x: {
											display: false,
											grid: {
												display: false,
												drawBorder: false,
												borderColor: '#dadde2',
											},
										},
										y: {
											display: false,
											min: 0,
											max: this.get('hitsChartYMax'),
											grid: {
												display: true,
												borderColor: '#dadde2',
											},
										},
									},
								},
							});
						});
					}
				});

				if (!this.get('version')) {
					this.set('version', this.get('package.version'));
				}
			}
		},
		onrender () {
			let resize = debounce(() => {
				this.add('_resizeId');
			});

			this.on('unrender', () => $(window).off('resize', resize));
			$(window).on('resize', resize);
			resize();
		},
	};
</script>
